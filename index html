<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta charset="utf-8">
<title>Meet Up Pro</title>
<style>
  /* ===== Minimal Insta-DM style (dark) ===== */
  :root{--bg:#000;--bubble:#262626;--me:#0095f6;--accent:#ffcc00;}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#fff;height:100vh;display:flex;flex-direction:column}
  /* Top bar */
  header{height:56px;display:flex;align-items:center;gap:12px;padding:0 12px;border-bottom:1px solid #111}
  .title{font-weight:600}
  /* messages area */
  #messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .msg{max-width:78%;padding:10px 12px;border-radius:14px;background:var(--bubble);font-size:14px;line-height:1.3}
  .me{align-self:flex-end;background:var(--me);color:#fff}
  .meta{font-size:11px;color:#aaa;margin-top:6px}
  .media{border-radius:12px;overflow:hidden;display:block;max-width:260px}
  .media img, .media video{width:100%;display:block}
  /* input bar */
  #composer{display:flex;gap:8px;padding:10px;border-top:1px solid #111;align-items:center}
  #msgInp{flex:1;padding:12px;border-radius:22px;background:#111;border:1px solid #222;color:#fff}
  #sendBtn,#imgBtn{background:transparent;border:none;color:var(--accent);font-weight:700;padding:8px 10px;border-radius:8px}
  /* small */
  .typing{font-size:13px;color:#aaa;padding:0 12px 8px}
  .reaction{display:inline-block;margin-left:8px;cursor:pointer}
  .online-dot{width:10px;height:10px;background:#2ecc71;border-radius:50%;display:inline-block;margin-right:8px}
</style>
</head>
<body>

<header>
  <div class="online-dot" id="presenceDot" style="display:none"></div>
  <div class="title">Meet Up Pro</div>
  <div style="margin-left:auto;font-size:13px;color:#aaa" id="userNameTop"></div>
</header>

<div id="messages"></div>
<div class="typing" id="typingArea" style="display:none">typingâ€¦</div>

<!-- composer -->
<div id="composer">
  <input id="msgInp" placeholder="Message..." autocomplete="off" />
  <input type="file" id="fileInp" accept="image/*,video/*" style="display:none" />
  <button id="imgBtn" title="Attach">ðŸ“Ž</button>
  <button id="sendBtn">Send</button>
</div>

<!-- LOGIN modal (simple) -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center">
  <div style="width:92%;max-width:420px;background:#0b0b0b;padding:18px;border-radius:12px">
    <h3 style="margin:0 0 10px 0">Enter Room</h3>
    <input id="name" placeholder="Your name" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:8px" />
    <input id="pass" type="password" placeholder="Room password" style="width:100%;padding:10px;border-radius:8px;border:none;margin-bottom:10px" />
    <div style="display:flex;gap:8px">
      <button id="enterBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:var(--accent);font-weight:700">Enter</button>
      <button id="cancelBtn" style="flex:1;padding:10px;border-radius:8px;border:none;background:#222">Cancel</button>
    </div>
    <p style="font-size:12px;color:#888;margin-top:8px">Password only host set karega (host code me).</p>
  </div>
</div>

<!-- Firebase v9 modular CDN -->
<script type="module">
/* ====== CONFIG: Replace with your firebaseConfig from Firebase console ====== */
const firebaseConfig = {
  apiKey: "FIREBASE_APIKEY",
  authDomain: "FIREBASE_AUTHDOMAIN",
  projectId: "FIREBASE_PROJECTID",
  storageBucket: "FIREBASE_STORAGEBUCKET",
  messagingSenderId: "FIREBASE_SENDERID",
  appId: "FIREBASE_APPID",
  databaseURL: "FIREBASE_DBURL" // for realtime presence
};
/* ======================================================================== */

/* ===== HOST password (change here only) ===== */
const ROOM_PASSWORD = "trex123";
/* =========================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-storage.js";
import { getDatabase, ref as dref, onValue, set as rset, serverTimestamp as rts, onDisconnect } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);
const rdb = getDatabase(app);

const roomId = "meetup_pro_room"; // single room id â€” change if multiple rooms needed

// UI
const messagesEl = document.getElementById('messages');
const msgInp = document.getElementById('msgInp');
const sendBtn = document.getElementById('sendBtn');
const imgBtn = document.getElementById('imgBtn');
const fileInp = document.getElementById('fileInp');
const loginModal = document.getElementById('loginModal');
const enterBtn = document.getElementById('enterBtn');
const cancelBtn = document.getElementById('cancelBtn');
const nameInp = document.getElementById('name');
const passInp = document.getElementById('pass');
const typingArea = document.getElementById('typingArea');
const presenceDot = document.getElementById('presenceDot');
const userNameTop = document.getElementById('userNameTop');

let user = null;
let typingTimeout = null;

/* ===== presence path in realtime DB ===== */
function presencePath(uid){ return `presence/${roomId}/${uid}`}

/* ===== join room after password check ===== */
enterBtn.onclick = async () => {
  const nm = nameInp.value.trim();
  const pw = passInp.value.trim();
  if(!nm){ alert('Name daalo'); return; }
  if(pw !== ROOM_PASSWORD){ alert('Galat password'); return; }
  user = { id: 'u_' + Math.random().toString(36).slice(2,9), name: nm };
  userNameTop.innerText = nm;
  loginModal.style.display = 'none';
  setupPresence();
  startListening();
}

/* cancel hides modal */
cancelBtn.onclick = ()=> loginModal.style.display='none';

/* send text or media */
sendBtn.onclick = async ()=>{
  const txt = msgInp.value.trim();
  if(!txt && !fileInp.files.length) return;
  if(fileInp.files.length){
    // upload file then send message with media url
    const f = fileInp.files[0];
    const ext = f.type.startsWith('video') ? 'video' : 'image';
    const path = `rooms/${roomId}/media/${Date.now()}_${f.name}`;
    const ref = sref(storage, path);
    const snapshot = await uploadBytes(ref, f);
    const url = await getDownloadURL(snapshot.ref);
    await addMessage({ text: '', media: url, mediaType: ext });
    fileInp.value = '';
  } else {
    await addMessage({ text: txt });
    msgInp.value = '';
  }
}

/* attach file */
imgBtn.onclick = ()=> fileInp.click();

/* typing indicator */
msgInp.addEventListener('input', ()=>{
  if(!user) return;
  setTyping(true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=> setTyping(false), 1500);
});

/* add message to Firestore */
async function addMessage({text='', media=null, mediaType=null}){
  const col = collection(db, `rooms/${roomId}/messages`);
  await addDoc(col, {
    userId: user.id,
    userName: user.name,
    text,
    media: media || null,
    mediaType: mediaType || null,
    reactions: {},
    seenBy: [],
    ts: serverTimestamp()
  });
}

/* listen messages (realtime) */
function startListening(){
  const q = query(collection(db, `rooms/${roomId}/messages`), orderBy('ts'));
  onSnapshot(q, snap=>{
    messagesEl.innerHTML = '';
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const id = docSnap.id;
      renderMessage(id, data);
    });
    // scroll to bottom
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
}

/* render message element */
function renderMessage(id, data){
  const div = document.createElement('div');
  div.className = 'msg' + (data.userId === (user && user.id) ? ' me' : '');
  // media first
  if(data.media){
    const m = document.createElement('a');
    m.className = 'media';
    m.href = data.media;
    m.target = '_blank';
    if(data.mediaType === 'video'){
      m.innerHTML = `<video controls src="${data.media}"></video>`;
    } else {
      m.innerHTML = `<img src="${data.media}" alt="media">`;
    }
    div.appendChild(m);
  }
  if(data.text){
    const p = document.createElement('div');
    p.innerText = data.text;
    div.appendChild(p);
  }
  // meta: name + time + reactions + seen
  const meta = document.createElement('div');
  meta.className = 'meta';
  const t = data.ts && data.ts.toDate ? data.ts.toDate() : (data.ts? new Date(data.ts.seconds*1000): new Date());
  meta.innerHTML = `<strong style="font-size:13px">${data.userName}</strong> Â· ${formatTime(t)}`;
  // reactions
  const reactSpan = document.createElement('span');
  reactSpan.style.marginLeft='8px';
  reactSpan.innerHTML = reactionHtml(data.reactions || {});
  meta.appendChild(reactSpan);
  // seen count
  const seenCount = (data.seenBy && data.seenBy.length) ? ` Â· Seen ${data.seenBy.length}` : '';
  meta.innerHTML += seenCount;
  div.appendChild(meta);

  // reaction click (quick)
  reactSpan.addEventListener('click', ()=> toggleReaction(id, 'ðŸ‘'));

  messagesEl.appendChild(div);
}

/* reaction html helper */
function reactionHtml(obj){
  const keys = Object.keys(obj||{});
  if(keys.length===0) return '';
  return keys.map(k=>`${k} ${obj[k]}`).join(' ');
}

/* toggle reaction (simple emoji count) */
async function toggleReaction(msgId, emoji){
  const msgRef = doc(db, `rooms/${roomId}/messages/${msgId}`);
  // naive: update using updateDoc (no transaction for brevity)
  const d = (await msgRef.get?.())?.data?.() || null;
  // for compatibility, just add reaction locally by increment via updateDoc with field path
  // BUT modular SDK without transaction: try simple update
  try{
    await updateDoc(msgRef, { [`reactions.${emoji}`]: (d && d.reactions && d.reactions[emoji] ? d.reactions[emoji]+1 : 1) });
  }catch(e){
    // ignore
  }
}

/* presence: set / remove */
function setupPresence(){
  const p = presencePath(user.id);
  const ref = dref(rdb, p);
  // set online
  rset(ref, { name: user.name, online: true, lastSeen: Date.now() });
  // onDisconnect set offline
  onDisconnect(ref).set({ name: user.name, online: false, lastSeen: Date.now() });
  // listen presence of room (anyone online)
  const roomPresRef = dref(rdb, `presence/${roomId}`);
  onValue(roomPresRef, snap=>{
    const v = snap.val() || {};
    const anyOnline = Object.values(v).some(x=>x && x.online);
    presenceDot.style.display = anyOnline ? 'inline-block' : 'none';
  });
  // mark messages seen when we open
  markAllSeen();
}

/* mark all messages seen by this user */
async function markAllSeen(){
  // naive: fetch recent messages and append user.id to seenBy array via updateDoc
  // For brevity, we skip implementation complexity â€” Firestore batch updates recommended
}

/* typing indicator using Realtime DB */
let typingRef = null;
function setTyping(val){
  if(!user) return;
  const tpath = `typing/${roomId}/${user.id}`;
  const ref = dref(rdb, tpath);
  rset(ref, { name: user.name, typing: val });
  // listen for others
  const allTypingRef = dref(rdb, `typing/${roomId}`);
  onValue(allTypingRef, snap=>{
    const v = snap.val() || {};
    const othersTyping = Object.values(v).some(x=>x && x.typing && x.name !== user.name);
    typingArea.style.display = othersTyping ? 'block' : 'none';
  });
}

/* helper format time */
function formatTime(d){
  const hh = d.getHours().toString().padStart(2,'0');
  const mm = d.getMinutes().toString().padStart(2,'0');
  return `${hh}:${mm}`;
}

/* initial scroll to bottom helper */
messagesEl.addEventListener('DOMNodeInserted', e=>{
  messagesEl.scrollTop = messagesEl.scrollHeight;
});
</script>

</body>
</html>
